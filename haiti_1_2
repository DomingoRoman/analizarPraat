# Script en Praat
# Laboratorio de Fonética USACH 2017
# estudio de pronunciación de haitianos

directorio$ = chooseDirectory$: "Elige la carpeta para los archivos"

sonido = selected ("Sound")
tgrid = selected("TextGrid")

select tgrid
form data
    real informante 1
    choice tipo_inform 2
		option estudio
		option control
	choice sexo_inform 1
		option hombre
		option mujer
endform

if tipo_inform == 1
	tipo_inform_2$ = "est"
	color = Colour: "blue"
elsif tipo_inform == 2
	tipo_inform_2$ = "con"
	color = Colour: "green"
endif

if sexo_inform == 1
	sexo_inform2$ = "h"
	maxHz = 5000
elsif sexo_inform == 2
	sexo_inform2$ = "m"
	maxHz = 5500
endif

informante$ = string$(informante)


n  = Get number of intervals: 1

for i to n
    ini [i] = Get start time of interval: 1, i
    fin [i] = Get end time of interval: 1, i
endfor

for i to n
    select sonido
    snd = Extract part: ini[i], fin[i], "rectangular", 1, "no"
    select tgrid
    tgr = Extract part: ini[i], fin[i], "no"
	tgr$ = selected$("TextGrid")
	n_inter_tgr = Get number of intervals: 2
		if n_inter_tgr == 3
			palabra$ = Get label of interval: 2, 2

#	Número de sonidos
			n_sonidos = Get number of points: 3
			name$ = Rename: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$

#	Duración de la palabra
			fin = Get end time of interval: 2, 2
			ini = Get start time of interval: 2, 2
			dur = fin-ini

# 	velocidad fonética
			velFonet =  dur/n_sonidos

#	Guarda el TextGrid
			Save as text file: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$+ ".TextGrid"

#	Guarda el audio
  			select snd
			Rename: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$
			Save as WAV file: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$ + ".wav"

# 	Crea tabla de datos
			tabl = Create Table with column names: "tabla", 1, "informante tipo sexo 
			... palabra duracion velFonet 
			... velSilFonol velSilFonet"

#	Inserta valores en la tabla de datos
			Set numeric value: 1, "informante", informante
			Set string value: 1, "sexo", sexo_inform2$
			Set string value: 1, "tipo", tipo_inform_2$
			Set string value: 1, "palabra", palabra$
			Set numeric value: 1, "duracion", dur
			Set numeric value: 1, "velFonet", velFonet

#	Guarda la tabla de datos
			Rename: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$
			Save as comma-separated file: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$ +".Table"

# ETAPA Gráficos
			Erase all
			
				select snd
				snd$ = selected$("Sound")
				espectrograma = To Spectrogram: 0.005, maxHz, 0.002, 20, "Gaussian"

				select tgr
				tier = Extract one tier: 3

				select snd
				Select inner viewport: 0.5, 6, 0.5, 2
				color
				Draw: 0, 0, 0, 0, "no", "Curve"
				One mark left: 0, "yes", "no", "yes", ""
				Draw inner box
				Select inner viewport: 0.5, 6, 2, 4
				select espectrograma
				Paint: 0, 0, 0, 0, 100, "yes", 50, 6, 0, "no"
				Marks right every: 1000, 1, "yes", "yes", "yes"
				Text right: "yes", "KHz"
				Draw inner box

				Select inner viewport: 0.5, 6, 0.4999999999999996, 4.875
				select tier
				Black
				Draw: 0, 0, "yes", "yes", "no"
				Draw inner box
				pause
				Select inner viewport: 0.5, 6, 0.4999999999999996, 4.875
				Text top: "no", snd$
				Select outer viewport: 0.35, 6.6, 0.28, 4.875
				Save as PDF file: tipo_inform_2$+"-"+informante$+"-"+sexo_inform2$+"-"+palabra$ + ".pdf"
				pause
		endif
endfor
